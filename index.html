<!DOCTYPE html>
<html lang="ro">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coji - Radio Player</title>
  <script src="./tailwindjs.js"></script>
  <!-- Favicon -->
  <link rel="icon" href="./favicon.png" type="image/x-icon">
  <meta name="theme-color" content="#fffdef" />
  <meta name="description" content="Coji Radio Player - AscultÄƒ posturile tale de radio preferate.">
  <!-- ios theme color for head -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Coji Radio Player">
  <link rel="apple-touch-icon" href="./logo-large.png">
  <link rel="apple-touch-startup-image" href="./logo-large.png">

  <style type="text/tailwindcss">
    @theme {
        --color-Border: #eeebd8;
        --color-Brown: #543416;
        --color-LightBrown: #865E5E;
        --color-LighterBrown: #AEA092;
        --color-SuperLighterBrown: #E7D7C8;
        --color-Bg: #fffdef;
        --color-Red: #e95d5d;
        --color-Green: #4b7716;
        --color-White: #ffffff;
        --color-LogoBody: #6FA68C;
        --color-LogoLeg: #216155;
        --color-LogoWing: #74CCA2;
      }

  </style>

</head>

<body class="bg-Bg p-4 flex flex-col justify-center items-center">
  <div class="text-center relative z-10">
    <img src="./logo-large.png" alt="Coji Radio Player" class="w-28 mx-auto">
    <h1 class="uppercase -mt-8 text-sm text-Brown">Radio Player Romania
      <span class="inline-flex items-center" title="Steagul RomÃ¢niei">
        <span class="sr-only">ðŸ‡·ðŸ‡´</span>
        <span class="w-[.5em] h-[0.75em] bg-blue-600 inline-block"></span>
        <span class="w-[.7em] h-[0.75em] bg-yellow-400 inline-block"></span>
        <span class="w-[.5em] h-[0.75em] bg-red-600 inline-block"></span>
      </span>

    </h1>
  </div>

  

  <div
    class="rounded-3xl shadow-xl w-full max-w-[540px] bg-gradient-to-t from-White to-bg text-white min-h-[calc(100dvh-180px)] flex flex-col align-center justify-end relative">
    <div class="absolute top-0 left-0 w-[120%] h-[100%] -m-[10%] bg-gradient-to-b from-Bg to-transparent"></div>
    <div class="">
      <!-- Poster Image -->
      <div id="posterImage"
        class="mx-auto rounded-3xl overflow-hidden w-[128px] h-[128px] bg-Red border border-Border relative z-10 mt-10">
        <img src="https://placehold.co/512x512?text=Coji%20Radio%20Player" alt="Coji Radio Player"
          class="w-full h-full object-cover">
      </div>


      <!-- PlayerControls -->
      <!-- Button with move down a bit on press-->

      <div class="flex items-center justify-center mt-20 relative z-10">
        <button id="prevButton" class="stroke-Red hover:stroke-Brown w-1/3 flex justify-center active:translate-y-1">
          <svg class="h-20 max-w-[20%]" viewBox="0 0 65 107" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M61.8923 103.771L3 53.4709" stroke-width="6" stroke-linecap="round" />
            <path d="M3 53.3854L61.8923 3.08551" stroke-width="6" stroke-linecap="round" />
          </svg>

        </button>
        <button id="playButton" class="stroke-Red hover:stroke-Brown w-1/3 flex justify-center active:translate-y-1">
          <svg class="h-20 max-w-[50%]" viewBox="0 0 129 129" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="64.5" cy="64.5" r="62" stroke-width="6" stroke-linecap="round" />
            <path d="M51.8684 36.2605L90.4966 64.1943L51.8684 92.1281L51.8684 36.2605Z" stroke-width="5"
              stroke-linecap="round" />
          </svg>
        </button>
        <button id="pauseButton"
          class="stroke-Red hover:stroke-Brown w-1/3 justify-center flex hidden active:translate-y-1">
          <svg class="h-20 max-w-[50%]" viewBox="0 0 129 129" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="64.5" cy="64.5" r="62" stroke-width="6" stroke-linecap="round" />
            <path d="M51 38L51 96" stroke-width="6" stroke-linecap="round" />
            <path d="M78 38L78 96" stroke-width="6" stroke-linecap="round" />
          </svg>
        </button>
        <button id="nextButton" class="stroke-Red hover:stroke-Brown w-1/3 flex justify-center active:translate-y-1">
          <svg class="h-20 max-w-[20%]" viewBox="0 0 65 106" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3.2146 3L62.1069 53.2999" stroke-width="6" stroke-linecap="round" />
            <path d="M62.1069 53.3854L3.21459 103.685" stroke-width="6" stroke-linecap="round" />
          </svg>
        </button>
      </div>



      <div class="h-10">
        <div id="loadingMsg" class="text-Brown text-center p-2 invisible ">Se Ã®ncarcÄƒ...</div>
        <div id="errorMsg" class="text-Red text-center p-2 invisible">Eroare la Ã®ncÄƒrcarea postului radio.</div>
      </div>

    </div>

  </div>

  <audio id="player" class="w-full">
    Browser-ul tÄƒu nu suportÄƒ tag-ul audio.
  </audio>

  <audio id="loadingNoise" loop>
    <source src="./loading-smaller.mp3" type="audio/mpeg">
  </audio>

  <audio id="errorNoise" loop>
    <source src="./error.mp3" type="audio/mpeg">
  </audio>

  <select id="radioSelect" class="border rounded-lg border-Border p-2 m-8 w-[70%] text-sm max-w-[540px] text-center">
    <option value="">Alege un post radio</option>
    <option value="https://live.kissfm.ro/kissfm.aacp">Kiss FM</option>
    <option value="https://astreaming.europafm.ro:8443/europafm_aacp48k">Europa FM</option>
    <option value="http://zuicast.digitalag.ro:9420/zu">Radio ZU</option>
    <option value="https://edge76.rcs-rds.ro/digifm/digifm.mp3?111">Digi FM</option>
    <option value="https://live.magicfm.ro/magicfm.aacp">Magic FM</option>
    <option value="https://astreaming.virginradio.ro:8443/virgin_aacp_64k">Virgin Radio RO</option>
    <option value="https://stream4.srr.ro:8443/romania-actualitati">RomÃ¢nia ActualitÄƒÈ›i</option>
    <option value="https://edge126.rcs-rds.ro/profm/profm.mp3?1741968671569">ProFM</option>
    <option value="https://live.rockfm.ro/rockfm.aacp">Rock FM</option>
    <option value="https://live.guerrillaradio.ro:8443/guerrilla.aac">Radio Guerrilla</option>
    <option value="https://asculta.nationalfm.ro:9102/nfm2">National FM</option>
    <option value="https://edge126.rcs-rds.ro/profm/dancefm.mp3?1741969012508">Dance FM</option>
    <option value="https://astreaming.vibefm.ro:8443/vibefm_aacp64k">Vibe FM</option>
    <option value="https://stream4.srr.ro:8443/romania-cultural">Cultural</option>
    <option value="https://stream4.srr.ro:8443/romania-muzical">Muzical</option>
  </select>

  <!-- Creator info: Adrian Florescu (http://adrianf.com) -->
  <footer class="text-center text-xs text-Brown mt-8">
    <p>Coji Radio Player</p>
    <p>Â© 2025 Adrian Florescu | <a href="https://adrianf.com" target="_blank" rel="noopener">adrianf.com</a></p>
  </footer>

  <script type="module">
    const radioSelect = document.getElementById('radioSelect');
    const player = document.getElementById('player');
    const loadingNoise = document.getElementById('loadingNoise');
    const errorNoise = document.getElementById('errorNoise');
    const loadingMsg = document.getElementById('loadingMsg');
    const errorMsg = document.getElementById('errorMsg');

    const prevButton = document.getElementById('prevButton');
    const playButton = document.getElementById('playButton');
    const pauseButton = document.getElementById('pauseButton');
    const nextButton = document.getElementById('nextButton');

    const posterImage = document.getElementById('posterImage');

    let hasError = false;
    let isLoading = false;

    function cloudinaryImageUrl(text) {
      return `https://res.cloudinary.com/adrianf/image/upload/c_scale,h_480,w_480/w_400,c_fit,l_text:arial_90:${text}/nndti4oybhdzggf8epvh`;
    }

    posterImage.querySelector('img').src = cloudinaryImageUrl('Coji Radio Player');

    const updateMediaSession = () => {
      const title = radioSelect.options[radioSelect.selectedIndex].text;
      if ('mediaSession' in navigator) {

        navigator.mediaSession.metadata = new MediaMetadata({
          title: isLoading ? `Se Ã®ncarcÄƒ...${title}` : hasError ? `Eroare la Ã®ncÄƒrcarea ${title}` : title,
          artist: `Coji Radio Player | ${title}`,
          artwork: [{ src: cloudinaryImageUrl(isLoading ? 'Se Ã®ncarcÄƒ...' : hasError ? 'Eroare' : title) }]
        });
        navigator.mediaSession.setActionHandler('previoustrack', prevRadio);
        navigator.mediaSession.setActionHandler('nexttrack', nextRadio);
        navigator.mediaSession.setActionHandler('pause', () => player.pause());
        navigator.mediaSession.setActionHandler('play', () => player.play());
      }

      // update poster image
      posterImage.querySelector('img').src = cloudinaryImageUrl(isLoading ? 'Se Ã®ncarcÄƒ...' : hasError ? 'Eroare' : title);

      // update document title
      document.title = `Coji Radio Player | ${isLoading ? `Se incarca ${title}` : hasError ? 'Eroare' : title}`;

      // update loading message
      loadingMsg.innerText = isLoading ? `Se incarca ${title}...` : '';
    };

    function audioInstance(htmlElement) {
      let initialSrc = htmlElement.querySelector('source').src;
      let isPlaying = false;

      const instance = {};
      instance.src = initialSrc;

      instance.play = () => {
        if (!isPlaying) {
          console.log('Play audio', { htmlSrc: htmlElement.src, instanceSrc: instance.src });
          htmlElement.src = instance.src;
          isPlaying = true;
          htmlElement.play().catch((error) => {
            if (error.name !== 'AbortError') {
              console.error('Error playing audio:', error);
            }
            isPlaying = false;
          });

          // lower volume for loading and error noises
          if (htmlElement === loadingNoise || htmlElement === errorNoise) {
            htmlElement.volume = 0.3;
          }
        }
      };

      instance.stop = () => {
        if (isPlaying) {
          console.log('Stop audio', { htmlSrc: htmlElement.src, instanceSrc: instance.src });
          htmlElement.pause();
          htmlElement.src = '';
          isPlaying = false;
        }
      };

      return instance;
    }


    const loadingNoiseInstance = audioInstance(loadingNoise);
    const errorNoiseInstance = audioInstance(errorNoise);

    const playRadio = (index) => {
      console.log('playRadio', { index: index, value: radioSelect.value });
      radioSelect.selectedIndex = index;

      isLoading = true;
      hasError = false;

      updateMediaSession();

      errorNoiseInstance.stop();
      loadingNoiseInstance.play();

      loadingMsg.classList.remove('invisible');
      errorMsg.classList.add('invisible');




      player.src = radioSelect.value;


      player.play().then(() => {
        isLoading = false;
        hasError = false;
        loadingMsg.classList.add('invisible');
        errorMsg.classList.add('invisible');

        loadingNoiseInstance.stop();

        updateMediaSession();
      }).catch(error => {

        if (error.name === 'AbortError') {
          return;
        }

        console.log('Error playing radio:', error);

        isLoading = false;
        hasError = true;

        loadingMsg.classList.add('invisible');
        errorMsg.classList.remove('invisible');

        loadingNoiseInstance.stop();
        errorNoiseInstance.play();
        updateMediaSession();
      });
    };

    radioSelect.addEventListener('change', (e) => {
      if (e.target.value) {
        playRadio(radioSelect.selectedIndex);
      } else {
        player.pause();
        player.src = '';
      }
    });

    const prevRadio = () => {
      console.log('prevRadio');
      playRadio(radioSelect.selectedIndex > 1 ? radioSelect.selectedIndex - 1 : radioSelect.options.length - 1);
    };

    const nextRadio = () => {
      console.log('nextRadio');
      playRadio(radioSelect.selectedIndex < radioSelect.options.length - 1 ? radioSelect.selectedIndex + 1 : 1);
    };

    if (window.electronAPI) {
      window.electronAPI.onMediaControl((command) => {
        console.log("ComandÄƒ media primitÄƒ:", command);


        if (command === "playpause") {
          if (player.paused) {
            player.play();
          } else {
            player.pause();
          }
        } else if (command === "next") {
          // Implementare pentru trecerea la urmÄƒtoarea melodie
          console.log("Next track (nu este implementat)");
          nextRadio();
        } else if (command === "previous") {
          // Implementare pentru melodia anterioarÄƒ
          console.log("Previous track (nu este implementat)");
          prevRadio();
        }
      });

      // **MonitorizeazÄƒ starea audio È™i o trimite la Electron**
      document.addEventListener("DOMContentLoaded", () => {
        function updatePlaybackState() {
          window.electronAPI.updatePlaybackState(!player.paused);
        }

        player.addEventListener("play", updatePlaybackState);
        player.addEventListener("pause", updatePlaybackState);
      });

    }


    // play button logic
    // on play, if no radio is selected, play the first one and make it selected
    // also hide the play button and show the pause button
    // on pause, show the play button and hide the pause button

    playButton.addEventListener('click', () => {
      if (player.paused) {
        if (radioSelect.selectedIndex === 0) {
          playRadio(1);
        } else {
          player.play();
        }
      }
    });

    pauseButton.addEventListener('click', () => {
      player.pause();
    });

    player.addEventListener('play', () => {
      playButton.classList.add('hidden');
      pauseButton.classList.remove('hidden');
    });

    player.addEventListener('pause', () => {
      playButton.classList.remove('hidden');
      pauseButton.classList.add('hidden');
    });

    // prev and next buttons
    prevButton.addEventListener('click', prevRadio);
    nextButton.addEventListener('click', nextRadio);


  </script>
</body>

</html>