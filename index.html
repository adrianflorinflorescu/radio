<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coji - Radio Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Favicon -->
  <link rel="icon" href="./favicon.png" type="image/x-icon">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center flex-col p-2">
    <div class="text-center mb-16">
      <img src="./logo-large.png" alt="Coji Radio Player" class="w-16 mx-auto">
      <h1 class="uppercase -mt-2 mb-2 text-sm">Coji Radio Player</h1>
    </div>

  <div class="bg-white rounded-3xl shadow-xl w-full max-w-[540px]">

    <!-- Poster Image -->
    <div id="posterImage" class="mx-auto rounded-3xl overflow-hidden  w-[128px] h-[128px] -mt-16 bg-slate-400">
      <img src="https://placehold.co/512x512?text=Coji%20Radio%20Player" alt="Coji Radio Player" class="w-full h-full object-cover">
    </div>


    <!-- PlayerControls -->
    <!-- Button with move down a bit on press-->

    <div class="flex items-center justify-center ">
      <button id="prevButton" class="stroke-slate-400 hover:stroke-slate-600 w-1/3 flex justify-center active:translate-y-1">
        <svg class="h-32 max-w-[20%]" viewBox="0 0 65 107" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M61.8923 103.771L3 53.4709" stroke-width="5" stroke-linecap="round"/>
          <path d="M3 53.3854L61.8923 3.08551" stroke-width="5" stroke-linecap="round"/>
        </svg>
          
      </button>
      <button id="playButton" class="stroke-slate-400 hover:stroke-slate-600 w-1/3 flex justify-center active:translate-y-1">
        <svg class="h-32 max-w-[40%]" viewBox="0 0 129 129" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="64.5" cy="64.5" r="62" stroke-width="5" stroke-linecap="round"/>
          <path d="M51.8684 36.2605L90.4966 64.1943L51.8684 92.1281L51.8684 36.2605Z" stroke-width="5" stroke-linecap="round"/>
        </svg>
      </button>
      <button id="pauseButton" class="stroke-slate-400 hover:stroke-slate-600 w-1/3 justify-center flex hidden active:translate-y-1">
        <svg class="h-32 max-w-[40%]" viewBox="0 0 129 129" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="64.5" cy="64.5" r="62" stroke-width="5" stroke-linecap="round"/>
          <path d="M51 38L51 96" stroke-width="6" stroke-linecap="round"/>
          <path d="M78 38L78 96" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>
      <button id="nextButton" class="stroke-slate-400 hover:stroke-slate-600 w-1/3 flex justify-center active:translate-y-1">
        <svg class="h-32 max-w-[20%]" viewBox="0 0 65 106" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3.2146 3L62.1069 53.2999" stroke-width="5" stroke-linecap="round"/>
          <path d="M62.1069 53.3854L3.21459 103.685" stroke-width="5" stroke-linecap="round"/>
        </svg>          
      </button>
    </div>



    <div id="loadingMsg" class="text-slate-500 text-center invisible mb-4 -mt-4">Se încarcă...</div>
    <div id="errorMsg" class="text-red-500 text-center invisible mb-4 -mt-4">
      <p>Eroare la încărcarea postului radio.</p>
    </div>



  </div>

  <audio id="player" class="w-full">
    Browser-ul tău nu suportă tag-ul audio.
  </audio>

  <audio id="loadingNoise" loop>
    <source src="./loading.mp3" type="audio/mpeg">
  </audio>

  <audio id="errorNoise" loop>
    <source src="./error.mp3" type="audio/mpeg">
  </audio>

  <select id="radioSelect" class="w-full border rounded-lg p-2 m-12  max-w-[540px]">
    <option value="">Alege un post radio</option>
    <option value="https://live.kissfm.ro/kissfm.aacp">Kiss FM</option>
    <option value="https://astreaming.europafm.ro:8443/europafm_aacp48k">Europa FM</option>
    <option value="http://zuicast.digitalag.ro:9420/zu">Radio ZU</option>
    <option value="https://edge76.rcs-rds.ro/digifm/digifm.mp3?111">Digi FM</option>
    <option value="https://live.magicfm.ro/magicfm.aacp">Magic FM</option>
    <option value="https://astreaming.virginradio.ro:8443/virgin_aacp_64k">Virgin Radio RO</option>
    <option value="https://stream4.srr.ro:8443/romania-actualitati">România Actualități</option>
    <option value="https://edge126.rcs-rds.ro/profm/profm.mp3?1741968671569">ProFM</option>
    <option value="https://live.rockfm.ro/rockfm.aacp">Rock FM</option>
    <option value="https://live.guerrillaradio.ro:8443/guerrilla.aac">Radio Guerrilla</option>
    <option value="https://asculta.nationalfm.ro:9102/nfm2">National FM</option>
    <option value="https://edge126.rcs-rds.ro/profm/dancefm.mp3?1741969012508">Dance FM</option>
    <option value="https://astreaming.vibefm.ro:8443/vibefm_aacp64k">Vibe FM</option>
    <option value="https://stream4.srr.ro:8443/romania-cultural">Cultural</option>
    <option value="https://stream4.srr.ro:8443/romania-muzical">Muzical</option>
  </select>

  <script type="module">
    const radioSelect = document.getElementById('radioSelect');
    const player = document.getElementById('player');
    const loadingNoise = document.getElementById('loadingNoise');
    const errorNoise = document.getElementById('errorNoise');
    const loadingMsg = document.getElementById('loadingMsg');
    const errorMsg = document.getElementById('errorMsg');
    
    const prevButton = document.getElementById('prevButton');
    const playButton = document.getElementById('playButton');
    const pauseButton = document.getElementById('pauseButton');
    const nextButton = document.getElementById('nextButton');

    const posterImage = document.getElementById('posterImage');

    let hasError = false;
    let isLoading = false;

    const updateMediaSession = () => {
      if ('mediaSession' in navigator) {
        const title = radioSelect.options[radioSelect.selectedIndex].text;
        navigator.mediaSession.metadata = new MediaMetadata({
          title: isLoading ? `Se încarcă...${title}` : hasError ? `Eroare la încărcarea ${title}` : title,
          artist: `Coji Radio Player | ${title}`,
          artwork: [{ src: `https://placehold.co/512x512?text=${isLoading ? 'Se încarcă...' : hasError ? 'Eroare' : radioSelect.options[radioSelect.selectedIndex].text}` }]
        });
        navigator.mediaSession.setActionHandler('previoustrack', prevRadio);
        navigator.mediaSession.setActionHandler('nexttrack', nextRadio);
        navigator.mediaSession.setActionHandler('pause', () => player.pause());
        navigator.mediaSession.setActionHandler('play', () => player.play());
      }

      // update poster image
      posterImage.querySelector('img').src = `https://placehold.co/512x512?text=${isLoading ? 'Se încarcă...' : hasError ? 'Eroare' : radioSelect.options[radioSelect.selectedIndex].text}`;
    };

    function audioInstance(htmlElement) {
      let initialSrc = htmlElement.querySelector('source').src;
      let isPlaying = false;

      const instance = {};
      instance.src = initialSrc;

      instance.play = () => {
        if (!isPlaying) {
          console.log('Play audio', {htmlSrc: htmlElement.src, instanceSrc: instance.src});
          htmlElement.src = instance.src;
          isPlaying = true;
          htmlElement.play().catch((error) => {
            if (error.name !== 'AbortError') {
              console.error('Error playing audio:', error);
            }
            isPlaying = false;
          });

          // lower volume for loading and error noises
          if (htmlElement === loadingNoise || htmlElement === errorNoise) {
            htmlElement.volume = 0.5;
          }
        }
      };

      instance.stop = () => {
        if (isPlaying) {
          console.log('Stop audio', {htmlSrc: htmlElement.src, instanceSrc: instance.src});
          htmlElement.pause();
          htmlElement.src = '';
          isPlaying = false;
        }
      };

      return instance;
    }


    const loadingNoiseInstance = audioInstance(loadingNoise);
    const errorNoiseInstance = audioInstance(errorNoise);

    const playRadio = async (index) => {
      console.log('playRadio');
 
      isLoading = true;
      hasError = false;
      player.pause();
      player.src = '';

      loadingNoiseInstance.stop();
      errorNoiseInstance.stop();
      
      loadingNoiseInstance.play();

 

      
      loadingMsg.classList.remove('invisible');
      errorMsg.classList.add('invisible');
      
      updateMediaSession();

      await new Promise(resolve => setTimeout(resolve, 1000));

      radioSelect.selectedIndex = index;
      player.src = radioSelect.value;


      player.play().then(() => {
        isLoading = false;
        hasError = false;
        loadingMsg.classList.add('invisible');
        errorMsg.classList.add('invisible');
        
        loadingNoiseInstance.stop();
        errorNoiseInstance.stop();

        updateMediaSession();
      }).catch(error => {

        if(error.name === 'AbortError') {
          return;
        }

        console.log('Error playing radio:', error);
        
        isLoading = false;
        hasError = true;

        loadingMsg.classList.add('invisible');
        errorMsg.classList.remove('invisible');
        
        loadingNoiseInstance.stop();
        errorNoiseInstance.play();
        updateMediaSession();
      });
    };

    radioSelect.addEventListener('change', (e) => {
      if (e.target.value) {
        playRadio(radioSelect.selectedIndex);
      } else {
        player.pause();
        player.src = '';
      }
    });

    const prevRadio = () => {
      console.log('prevRadio');
      playRadio(radioSelect.selectedIndex > 1 ? radioSelect.selectedIndex - 1 : radioSelect.options.length - 1);
    };

    const nextRadio = () => {
      console.log('nextRadio');
      playRadio(radioSelect.selectedIndex < radioSelect.options.length - 1 ? radioSelect.selectedIndex + 1 : 1);
    };

    if (window.electronAPI) {
      window.electronAPI.onMediaControl((command) => {
        console.log("Comandă media primită:", command);


        if (command === "playpause") {
          if (player.paused) {
            player.play();
          } else {
            player.pause();
          }
        } else if (command === "next") {
          // Implementare pentru trecerea la următoarea melodie
          console.log("Next track (nu este implementat)");
          nextRadio();
        } else if (command === "previous") {
          // Implementare pentru melodia anterioară
          console.log("Previous track (nu este implementat)");
          prevRadio();
        }
      });

        // **Monitorizează starea audio și o trimite la Electron**
      document.addEventListener("DOMContentLoaded", () => {
        function updatePlaybackState() {
          window.electronAPI.updatePlaybackState(!player.paused);
        }

        player.addEventListener("play", updatePlaybackState);
        player.addEventListener("pause", updatePlaybackState);
      });
      
    }


    // play button logic
    // on play, if no radio is selected, play the first one and make it selected
    // also hide the play button and show the pause button
    // on pause, show the play button and hide the pause button

    playButton.addEventListener('click', () => {
      if (player.paused) {
        if (radioSelect.selectedIndex === 0) {
          playRadio(1);
        } else {
          player.play();
        }
      }
    });

    pauseButton.addEventListener('click', () => {
      player.pause();
    });

    player.addEventListener('play', () => {
      playButton.classList.add('hidden');
      pauseButton.classList.remove('hidden');
    });

    player.addEventListener('pause', () => {
      playButton.classList.remove('hidden');
      pauseButton.classList.add('hidden');
    });

    // prev and next buttons
    prevButton.addEventListener('click', prevRadio);
    nextButton.addEventListener('click', nextRadio);


  </script>
</body>
</html>
